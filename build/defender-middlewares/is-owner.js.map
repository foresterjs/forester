{"version":3,"sources":["../../lib/defender-middlewares/is-owner.js"],"names":[],"mappings":"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","file":"is-owner.js","sourcesContent":["\"use strict\";\n\nmodule.exports = function (rule, collection) {\n\n  if(rule.relation){\n    return checkStoredData(rule, collection);\n  }\n\n  if (rule.action == 'find') {\n    return checkWhere(rule);\n  }\n\n  if (rule.action == 'create') {\n    return checkData(rule);\n  }\n\n  if (rule.action == 'pick') {\n    return postCheckItem(rule);\n  }\n\n  if (rule.action == 'update' || rule.action == 'destroy') {\n    return checkStoredData(rule, collection);\n  }\n\n  throw new Error(\"isOwner is not supported on rule \" + rule.action);\n\n};\n\n\nexport function checkWhere(rule) {\n\n  return async function ({user, request, response}, next) {\n\n    if (!user) {\n      response.status = 403;\n      return;\n    }\n\n    var userId = user.id;\n\n    request.query = request.query || {};\n    request.query.where = request.query.where || {};\n\n    if(request.query.where[rule.property] !== userId){\n      response.status = 403;\n      return;\n    }\n\n    await next();\n\n  };\n}\n\nexport function checkData(rule) {\n  return async function ({user, request, response}, next) {\n\n    if (!user) {\n      response.status = 403;\n      return;\n    }\n\n    request.body = request.body || {};\n\n    var userId = user.id;\n\n    if(request.body[rule.property] !== userId){\n      response.status = 403;\n      return;\n    }\n\n    await next();\n\n  };\n}\n\nexport function postCheckItem(rule) {\n  return async function ({body, request, response, user}, next) {\n\n    if (!user) {\n      response.status = 403;\n      return;\n    }\n\n    var userId = user.id;\n\n    await next();\n\n    if(!body.data || !body.data[rule.property] || body.data[rule.property] !== userId){\n      response.body = {};\n      response.status = 403;\n    }\n  };\n}\n\nexport function checkStoredData(rule, collection) {\n  return async function ({body, request, response, params, user}, next) {\n\n    if (!user) {\n      response.status = 403;\n      return;\n    }\n\n    var userId = user.id;\n    var id = params.id;\n\n    var item = await collection.pick(id);\n    if(!item){\n      response.body.done = false;\n      response.body.errors = ['not_found'];\n      return;\n    }\n\n    if(!item[rule.property] || item[rule.property] !== userId){\n      response.status = 403;\n      response.body = {};\n      return;\n    }\n\n    await next();\n  };\n}\n"]}