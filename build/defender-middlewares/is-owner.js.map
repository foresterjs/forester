{"version":3,"sources":["../../lib/defender-middlewares/is-owner.js"],"names":[],"mappings":"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","file":"is-owner.js","sourcesContent":["\"use strict\";\n\nmodule.exports = function (rule, collection) {\n\n  if(rule.relation){\n    return checkStoredData(rule, collection);\n  }\n\n  if (rule.action == 'find') {\n    return checkWhere(rule);\n  }\n\n  if (rule.action == 'create') {\n    return checkData(rule);\n  }\n\n  if (rule.action == 'pick') {\n    return postCheckItem(rule);\n  }\n\n  if (rule.action == 'update' || rule.action == 'destroy') {\n    return checkStoredData(rule, collection);\n  }\n\n  throw new Error(\"isOwner is not supported on rule \" + rule.action);\n\n};\n\n\nexport function checkWhere(rule) {\n\n  return async function ({user, request, response}, next) {\n\n    if (!user) {\n      response.status = 403;\n      return;\n    }\n\n    var userId = user.id;\n\n    request.query = request.query || {};\n    request.query.where = request.query.where || {};\n\n    if(request.query.where[rule.property] !== userId){\n      response.status = 403;\n      return;\n    }\n\n    await next();\n\n  };\n}\n\nexport function checkData(rule) {\n  return async function ({user, request, response}, next) {\n\n    if (!user) {\n      response.status = 403;\n      return;\n    }\n\n    request.body = request.body || {};\n\n    var userId = user.id;\n\n    if(request.body[rule.property] !== userId){\n      response.status = 403;\n      return;\n    }\n\n    await next();\n\n  };\n}\n\nexport function postCheckItem(rule) {\n  return async function ({body, request, response, user}, next) {\n\n    if (!user) {\n      response.status = 403;\n      return;\n    }\n\n    var userId = user.id;\n\n    await next();\n\n    if(!body.data || !body.data[rule.property] || body.data[rule.property] !== userId){\n      response.body = {};\n      response.status = 403;\n    }\n  };\n}\n\nexport function checkStoredData(rule, collection) {\n  return async function ({body, request, response, params, user}, next) {\n\n    if (!user) {\n      response.status = 403;\n      return;\n    }\n\n    var userId = user.id;\n    var id = params.id;\n\n    var item = await collection.pick(id);\n    if(!item){\n      response.body.done = false;\n      response.body.errors = ['not_found'];\n      return;\n    }\n\n    if(!item[rule.property] || item[rule.property] !== userId){\n      response.status = 403;\n      response.body = {};\n      return;\n    }\n\n    await next();\n  };\n}\n"]}