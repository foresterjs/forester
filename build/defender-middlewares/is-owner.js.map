{"version":3,"sources":["../../lib/defender-middlewares/is-owner.js"],"names":[],"mappings":"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","file":"is-owner.js","sourcesContent":["\"use strict\";\n\nmodule.exports = function (rule, collection) {\n\n  if(rule.relation){\n    return checkStoredData(rule, collection);\n  }\n\n  if (rule.action == 'find') {\n    return checkWhere(rule);\n  }\n\n  if (rule.action == 'create') {\n    return checkData(rule);\n  }\n\n  if (rule.action == 'pick') {\n    return postCheckItem(rule);\n  }\n\n  if (rule.action == 'update' || rule.action == 'destroy') {\n    return checkStoredData(rule, collection);\n  }\n\n  throw new Error(\"isOwner is not supported on rule \" + rule.action);\n\n};\n\n\nexport function checkWhere(rule) {\n\n  return async function ({user, request, response}, next) {\n\n    if (!user) {\n      response.status = 403;\n      return;\n    }\n\n    var userId = user.id;\n\n    request.query = request.query || {};\n    request.query.where = request.query.where || {};\n\n    if(request.query.where[rule.property] !== userId){\n      response.status = 403;\n      return;\n    }\n\n    await next();\n\n  };\n}\n\nexport function checkData(rule) {\n  return async function ({user, request, response}, next) {\n\n    if (!user) {\n      response.status = 403;\n      return;\n    }\n\n    request.body = request.body || {};\n\n    var userId = user.id;\n\n    if(request.body[rule.property] !== userId){\n      response.status = 403;\n      return;\n    }\n\n    await next();\n\n  };\n}\n\nexport function postCheckItem(rule) {\n  return async function ({body, request, response, user}, next) {\n\n    if (!user) {\n      response.status = 403;\n      return;\n    }\n\n    var userId = user.id;\n\n    await next();\n\n    if(!body.data || !body.data[rule.property] || body.data[rule.property] !== userId){\n      response.body = {};\n      response.status = 403;\n    }\n  };\n}\n\nexport function checkStoredData(rule, collection) {\n  return async function ({body, request, response, params, user}, next) {\n\n    if (!user) {\n      response.status = 403;\n      return;\n    }\n\n    var userId = user.id;\n    var id = params.id;\n\n    var item = await collection.pick(id);\n    if(!item){\n      response.body.done = false;\n      response.body.errors = ['not_found'];\n      return;\n    }\n\n    if(!item[rule.property] || item[rule.property] !== userId){\n      response.status = 403;\n      response.body = {};\n      return;\n    }\n\n    await next();\n  };\n}\n"]}