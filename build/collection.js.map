{"version":3,"sources":["../lib/collection.js"],"names":[],"mappings":"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","file":"collection.js","sourcesContent":["'use strict';\n\nvar EventEmitter = require('events');\nvar Sanitizer = require('./sanitizer');\nvar Defender = require('./defender');\n\nimport Validator from './validator';\n\nclass Collection {\n\n  constructor({dataSource, collectionSchema, collections}) {\n\n    this.defaults = {\n      page: 1,\n      perPage: 20\n    };\n\n    this.dataSource = dataSource;\n    this.collectionSchema = collectionSchema;\n    this.collections = collections;\n    this.eventEmitter = new EventEmitter();\n\n    this.sanitizer = new Sanitizer(this.schema.properties);\n    this.validator = new Validator(this.schema.properties);\n    this.defender = new Defender(this);\n  }\n\n  get name() {\n    return this.collectionSchema.name;\n  }\n\n  get schema() {\n    return this.collectionSchema;\n  }\n\n  addMethod(name, handler) {\n    this[name] = handler.bind(this);\n  }\n\n  async findAll({ where, orderBy, columns, page, perPage, include}) {\n    var options = arguments[0];\n\n    options.page = parseInt(options.page) || this.defaults.page;\n    options.perPage = parseInt(options.perPage) || this.defaults.perPage;\n\n    this.eventEmitter.emit('findAll:before', options);\n    var items = await this.dataSource.findAll(this.name, options);\n    if (include) items = await this.solveInclude(items, include);\n    this.eventEmitter.emit('findAll:after', options, items);\n\n    return items;\n  }\n\n  async pick(id, { include } = {}) {\n    this.eventEmitter.emit('pick:before', id);\n    var item = await this.dataSource.pick(this.name, id);\n    if (item && include) item = await this.solveInclude(item, include);\n    this.eventEmitter.emit('pick:after', id, item);\n\n    return item;\n  }\n\n  async create(data) {\n\n    this.eventEmitter.emit('create:before', data);\n    data = await this.sanitizer.sanitize(data);\n\n    var validation = await this.validator.validate(data);\n\n    if (validation) {\n      var item = await this.dataSource.create(this.name, data);\n      this.eventEmitter.emit('create:after', data, item);\n      return item;\n    }\n  }\n\n  async update(id, data) {\n\n    this.eventEmitter.emit('update:before', data);\n    data = await this.sanitizer.sanitize(data);\n\n    var validation = await this.validator.validate(data);\n\n    if (validation) {\n      var item = await this.dataSource.update(this.name, id, data);\n      this.eventEmitter.emit('update:after', data, item);\n      return item;\n    }\n  }\n\n  async destroy(id) {\n\n    this.eventEmitter.emit('destroy:before', id);\n    var result = await this.dataSource.destroy(this.name, id);\n    this.eventEmitter.emit('destroy:after', id, result);\n    return result;\n\n  }\n\n  async exists(id) {\n    this.eventEmitter.emit('exists:before', id);\n    var exists = await this.dataSource.exists(this.name, id);\n    this.eventEmitter.emit('exists:after', id, exists);\n    return exists;\n  }\n\n  async count(where = {}) {\n\n    var count = await this.dataSource.count(this.name, where);\n    return count;\n  }\n\n  async findOrPickThroughRelation(item, relation) {\n    var relationsSchema = this.schema.relations;\n    var relationSchema = relationsSchema[relation];\n\n    var type = relationSchema.type;\n    var foreignKey = relationSchema.foreignKey;\n    var foreignCollection = this.collections[relationSchema.collection];\n\n    var relationsMethods = {\n      belongsTo: function(){\n        var id = item[foreignKey];\n        return id ? foreignCollection.pick(id) : {};\n      },\n      hasMany: function(){\n        var where = {[foreignKey]: item.id};\n        return foreignCollection.findAll({where});\n      },\n      hasOne: function(){\n        //TODO\n        throw new Error('not implemented yet');\n      },\n      hasAndBelongsToMany: function(){\n        //TODO\n        throw new Error('not implemented yet');\n      },\n      hasManyThrough: function(){\n        //TODO\n        throw new Error('not implemented yet');\n      }\n    };\n\n    return await relationsMethods[type]();\n\n  }\n\n  async solveInclude(item, include) {\n\n    if (Array.isArray(item)) {\n      for (var j = 0; j < item.length; j++) {\n        await this.solveInclude(item[j], include);\n      }\n      return item;\n    }\n\n    for (var i = 0; i < include.length; i++) {\n      var relation = include[i];\n      item[relation] = await this.findOrPickThroughRelation(item, relation);\n    }\n\n    return item;\n  }\n\n  on(event, callback) {\n    this.eventEmitter.on(event, callback);\n  }\n}\n\nmodule.exports = Collection;\n"]}