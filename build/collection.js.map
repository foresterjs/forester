{"version":3,"sources":["../lib/collection.js"],"names":[],"mappings":"AAAA,YAAY,CAAC;;;;;;;;;;;;;;;;AAEb,IAAI,YAAY,GAAG,OAAO,CAAC,QAAQ,CAAC,CAAC;AACrC,IAAI,SAAS,GAAG,OAAO,CAAC,aAAa,CAAC,CAAC;AACvC,IAAI,QAAQ,GAAG,OAAO,CAAC,YAAY,CAAC,CAAC;;IAI/B,UAAU;AAEd,WAFI,UAAU,OAE2C;QAA5C,UAAU,QAAV,UAAU;QAAE,gBAAgB,QAAhB,gBAAgB;QAAE,WAAW,QAAX,WAAW;;0BAFlD,UAAU;;AAIZ,QAAI,CAAC,QAAQ,GAAG;AACd,UAAI,EAAE,CAAC;AACP,aAAO,EAAE,EAAE;KACZ,CAAC;;AAEF,QAAI,CAAC,UAAU,GAAG,UAAU,CAAC;AAC7B,QAAI,CAAC,gBAAgB,GAAG,gBAAgB,CAAC;AACzC,QAAI,CAAC,WAAW,GAAG,WAAW,CAAC;AAC/B,QAAI,CAAC,YAAY,GAAG,IAAI,YAAY,EAAE,CAAC;;AAEvC,QAAI,CAAC,SAAS,GAAG,IAAI,SAAS,CAAC,IAAI,CAAC,MAAM,CAAC,UAAU,CAAC,CAAC;AACvD,QAAI,CAAC,SAAS,GAAG,wBAAc,IAAI,CAAC,MAAM,CAAC,UAAU,CAAC,CAAC;AACvD,QAAI,CAAC,QAAQ,GAAG,IAAI,QAAQ,CAAC,IAAI,CAAC,CAAC;GACpC;;eAjBG,UAAU;;8BA2BJ,IAAI,EAAE,OAAO,EAAE;AACvB,UAAI,CAAC,IAAI,CAAC,GAAG,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;KACjC;;;;;YAEe,KAAK,SAAL,KAAK;YAAE,OAAO,SAAP,OAAO;YAAE,OAAO,SAAP,OAAO;YAAE,IAAI,SAAJ,IAAI;YAAE,OAAO,SAAP,OAAO;YAAE,OAAO,SAAP,OAAO;YACzD,OAAO;YAMP,KAAK;;;;;;AANL,uBAAO,GAAG,MAAU,CAAC,CAAC;;AAE1B,uBAAO,CAAC,IAAI,GAAG,OAAO,CAAC,IAAI,IAAI,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC;AAClD,uBAAO,CAAC,OAAO,GAAG,OAAO,CAAC,OAAO,IAAI,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC;;AAE3D,oBAAI,CAAC,YAAY,CAAC,IAAI,CAAC,gBAAgB,EAAE,OAAO,CAAC,CAAC;;uBAChC,IAAI,CAAC,UAAU,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,EAAE,OAAO,CAAC;;;AAAzD,qBAAK;;qBACL,OAAO;;;;;;uBAAgB,IAAI,CAAC,YAAY,CAAC,KAAK,EAAE,OAAO,CAAC;;;AAA/C,qBAAK;;;AAClB,oBAAI,CAAC,YAAY,CAAC,IAAI,CAAC,eAAe,EAAE,OAAO,EAAE,KAAK,CAAC,CAAC;;iDAEjD,KAAK;;;;;;;;;;;;;;;;;4EAGH,EAAE;0EAAgB,EAAE;;YAAd,OAAO,SAAP,OAAO;YAElB,IAAI;;;;;AADR,oBAAI,CAAC,YAAY,CAAC,IAAI,CAAC,aAAa,EAAE,EAAE,CAAC,CAAC;;uBACzB,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,EAAE,EAAE,CAAC;;;AAAhD,oBAAI;;sBACJ,IAAI,IAAI,OAAO,CAAA;;;;;;uBAAe,IAAI,CAAC,YAAY,CAAC,IAAI,EAAE,OAAO,CAAC;;;AAA7C,oBAAI;;;AACzB,oBAAI,CAAC,YAAY,CAAC,IAAI,CAAC,YAAY,EAAE,EAAE,EAAE,IAAI,CAAC,CAAC;;kDAExC,IAAI;;;;;;;;;;;;;;;;;4EAGA,IAAI;YAKX,UAAU,EAGR,IAAI;;;;;;AANV,oBAAI,CAAC,YAAY,CAAC,IAAI,CAAC,eAAe,EAAE,IAAI,CAAC,CAAC;;uBACjC,IAAI,CAAC,SAAS,CAAC,QAAQ,CAAC,IAAI,CAAC;;;AAA1C,oBAAI;;uBAEmB,IAAI,CAAC,SAAS,CAAC,QAAQ,CAAC,IAAI,CAAC;;;AAAhD,0BAAU;;qBAEV,UAAU;;;;;;uBACK,IAAI,CAAC,UAAU,CAAC,MAAM,CAAC,IAAI,CAAC,IAAI,EAAE,IAAI,CAAC;;;AAApD,oBAAI;;AACR,oBAAI,CAAC,YAAY,CAAC,IAAI,CAAC,cAAc,EAAE,IAAI,EAAE,IAAI,CAAC,CAAC;kDAC5C,IAAI;;;;;;;;;;;;;;;;;4EAIF,EAAE,EAAE,IAAI;YAKf,UAAU,EAGR,IAAI;;;;;;AANV,oBAAI,CAAC,YAAY,CAAC,IAAI,CAAC,eAAe,EAAE,IAAI,CAAC,CAAC;;uBACjC,IAAI,CAAC,SAAS,CAAC,QAAQ,CAAC,IAAI,CAAC;;;AAA1C,oBAAI;;uBAEmB,IAAI,CAAC,SAAS,CAAC,QAAQ,CAAC,IAAI,CAAC;;;AAAhD,0BAAU;;qBAEV,UAAU;;;;;;uBACK,IAAI,CAAC,UAAU,CAAC,MAAM,CAAC,IAAI,CAAC,IAAI,EAAE,EAAE,EAAE,IAAI,CAAC;;;AAAxD,oBAAI;;AACR,oBAAI,CAAC,YAAY,CAAC,IAAI,CAAC,cAAc,EAAE,IAAI,EAAE,IAAI,CAAC,CAAC;kDAC5C,IAAI;;;;;;;;;;;;;;;;;4EAID,EAAE;YAGV,MAAM;;;;;;AADV,oBAAI,CAAC,YAAY,CAAC,IAAI,CAAC,gBAAgB,EAAE,EAAE,CAAC,CAAC;;uBAC1B,IAAI,CAAC,UAAU,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,EAAE,EAAE,CAAC;;;AAArD,sBAAM;;AACV,oBAAI,CAAC,YAAY,CAAC,IAAI,CAAC,eAAe,EAAE,EAAE,EAAE,MAAM,CAAC,CAAC;kDAC7C,MAAM;;;;;;;;;;;;;;;;;4EAIF,EAAE;YAET,MAAM;;;;;AADV,oBAAI,CAAC,YAAY,CAAC,IAAI,CAAC,eAAe,EAAE,EAAE,CAAC,CAAC;;uBACzB,IAAI,CAAC,UAAU,CAAC,MAAM,CAAC,IAAI,CAAC,IAAI,EAAE,EAAE,CAAC;;;AAApD,sBAAM;;AACV,oBAAI,CAAC,YAAY,CAAC,IAAI,CAAC,cAAc,EAAE,EAAE,EAAE,MAAM,CAAC,CAAC;kDAC5C,MAAM;;;;;;;;;;;;;;;;;;YAGH,KAAK,yDAAG,EAAE;YAEhB,KAAK;;;;;;uBAAS,IAAI,CAAC,UAAU,CAAC,KAAK,CAAC,IAAI,CAAC,IAAI,EAAE,KAAK,CAAC;;;AAArD,qBAAK;kDACF,KAAK;;;;;;;;;;;;;;;;;4EAGkB,IAAI,EAAE,QAAQ;YACxC,eAAe,EACf,cAAc,EAEd,IAAI,EACJ,UAAU,EACV,iBAAiB,EAEjB,gBAAgB;;;;;AAPhB,+BAAe,GAAG,IAAI,CAAC,MAAM,CAAC,SAAS;AACvC,8BAAc,GAAG,eAAe,CAAC,QAAQ,CAAC;AAE1C,oBAAI,GAAG,cAAc,CAAC,IAAI;AAC1B,0BAAU,GAAG,cAAc,CAAC,UAAU;AACtC,iCAAiB,GAAG,IAAI,CAAC,WAAW,CAAC,cAAc,CAAC,UAAU,CAAC;AAE/D,gCAAgB,GAAG;AACrB,2BAAS,EAAE,qBAAU;AACnB,wBAAI,EAAE,GAAG,IAAI,CAAC,UAAU,CAAC,CAAC;AAC1B,2BAAO,EAAE,GAAG,iBAAiB,CAAC,IAAI,CAAC,EAAE,CAAC,GAAG,EAAE,CAAC;mBAC7C;AACD,yBAAO,EAAE,mBAAU;AACjB,wBAAI,KAAK,uBAAK,UAAU,EAAG,IAAI,CAAC,EAAE,CAAC,CAAC;AACpC,2BAAO,iBAAiB,CAAC,OAAO,CAAC,EAAC,KAAK,EAAL,KAAK,EAAC,CAAC,CAAC;mBAC3C;AACD,wBAAM,EAAE,kBAAU;;AAEhB,0BAAM,IAAI,KAAK,CAAC,qBAAqB,CAAC,CAAC;mBACxC;AACD,qCAAmB,EAAE,+BAAU;;AAE7B,0BAAM,IAAI,KAAK,CAAC,qBAAqB,CAAC,CAAC;mBACxC;AACD,gCAAc,EAAE,0BAAU;;AAExB,0BAAM,IAAI,KAAK,CAAC,qBAAqB,CAAC,CAAC;mBACxC;iBACF;;uBAEY,gBAAgB,CAAC,IAAI,CAAC,EAAE;;;;;;;;;;;;;;;;;;;;4EAIpB,IAAI,EAAE,OAAO;YAGnB,CAAC,EAMH,CAAC,EACJ,QAAQ;;;;;qBARV,KAAK,CAAC,OAAO,CAAC,IAAI,CAAC;;;;;AACZ,iBAAC,GAAG,CAAC;;;sBAAE,CAAC,GAAG,IAAI,CAAC,MAAM,CAAA;;;;;;uBACvB,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,OAAO,CAAC;;;AADV,iBAAC,EAAE;;;;;kDAG7B,IAAI;;;AAGJ,iBAAC,GAAG,CAAC;;;sBAAE,CAAC,GAAG,OAAO,CAAC,MAAM,CAAA;;;;;AAC5B,wBAAQ,GAAG,OAAO,CAAC,CAAC,CAAC;;uBACF,IAAI,CAAC,yBAAyB,CAAC,IAAI,EAAE,QAAQ,CAAC;;;AAArE,oBAAI,CAAC,QAAQ,CAAC;;;AAFoB,iBAAC,EAAE;;;;;kDAKhC,IAAI;;;;;;;;;;;;;;;;uBAGV,KAAK,EAAE,QAAQ,EAAE;AAClB,UAAI,CAAC,YAAY,CAAC,EAAE,CAAC,KAAK,EAAE,QAAQ,CAAC,CAAC;KACvC;;;wBA3IU;AACT,aAAO,IAAI,CAAC,gBAAgB,CAAC,IAAI,CAAC;KACnC;;;wBAEY;AACX,aAAO,IAAI,CAAC,gBAAgB,CAAC;KAC9B;;;SAzBG,UAAU;;;AAiKhB,MAAM,CAAC,OAAO,GAAG,UAAU,CAAC","file":"collection.js","sourcesContent":["'use strict';\n\nvar EventEmitter = require('events');\nvar Sanitizer = require('./sanitizer');\nvar Defender = require('./defender');\n\nimport Validator from './validator';\n\nclass Collection {\n\n  constructor({dataSource, collectionSchema, collections}) {\n\n    this.defaults = {\n      page: 1,\n      perPage: 20\n    };\n\n    this.dataSource = dataSource;\n    this.collectionSchema = collectionSchema;\n    this.collections = collections;\n    this.eventEmitter = new EventEmitter();\n\n    this.sanitizer = new Sanitizer(this.schema.properties);\n    this.validator = new Validator(this.schema.properties);\n    this.defender = new Defender(this);\n  }\n\n  get name() {\n    return this.collectionSchema.name;\n  }\n\n  get schema() {\n    return this.collectionSchema;\n  }\n\n  addMethod(name, handler) {\n    this[name] = handler.bind(this);\n  }\n\n  async findAll({ where, orderBy, columns, page, perPage, include}) {\n    var options = arguments[0];\n\n    options.page = options.page || this.defaults.page;\n    options.perPage = options.perPage || this.defaults.perPage;\n\n    this.eventEmitter.emit('findAll:before', options);\n    var items = await this.dataSource.findAll(this.name, options);\n    if (include) items = await this.solveInclude(items, include);\n    this.eventEmitter.emit('findAll:after', options, items);\n\n    return items;\n  }\n\n  async pick(id, { include } = {}) {\n    this.eventEmitter.emit('pick:before', id);\n    var item = await this.dataSource.pick(this.name, id);\n    if (item && include) item = await this.solveInclude(item, include);\n    this.eventEmitter.emit('pick:after', id, item);\n\n    return item;\n  }\n\n  async create(data) {\n\n    this.eventEmitter.emit('create:before', data);\n    data = await this.sanitizer.sanitize(data);\n\n    var validation = await this.validator.validate(data);\n\n    if (validation) {\n      var item = await this.dataSource.create(this.name, data);\n      this.eventEmitter.emit('create:after', data, item);\n      return item;\n    }\n  }\n\n  async update(id, data) {\n\n    this.eventEmitter.emit('update:before', data);\n    data = await this.sanitizer.sanitize(data);\n\n    var validation = await this.validator.validate(data);\n\n    if (validation) {\n      var item = await this.dataSource.update(this.name, id, data);\n      this.eventEmitter.emit('update:after', data, item);\n      return item;\n    }\n  }\n\n  async destroy(id) {\n\n    this.eventEmitter.emit('destroy:before', id);\n    var result = await this.dataSource.destroy(this.name, id);\n    this.eventEmitter.emit('destroy:after', id, result);\n    return result;\n\n  }\n\n  async exists(id) {\n    this.eventEmitter.emit('exists:before', id);\n    var exists = await this.dataSource.exists(this.name, id);\n    this.eventEmitter.emit('exists:after', id, exists);\n    return exists;\n  }\n\n  async count(where = {}) {\n\n    var count = await this.dataSource.count(this.name, where);\n    return count;\n  }\n\n  async findOrPickThroughRelation(item, relation) {\n    var relationsSchema = this.schema.relations;\n    var relationSchema = relationsSchema[relation];\n\n    var type = relationSchema.type;\n    var foreignKey = relationSchema.foreignKey;\n    var foreignCollection = this.collections[relationSchema.collection];\n\n    var relationsMethods = {\n      belongsTo: function(){\n        var id = item[foreignKey];\n        return id ? foreignCollection.pick(id) : {};\n      },\n      hasMany: function(){\n        var where = {[foreignKey]: item.id};\n        return foreignCollection.findAll({where});\n      },\n      hasOne: function(){\n        //TODO\n        throw new Error('not implemented yet');\n      },\n      hasAndBelongsToMany: function(){\n        //TODO\n        throw new Error('not implemented yet');\n      },\n      hasManyThrough: function(){\n        //TODO\n        throw new Error('not implemented yet');\n      }\n    };\n\n    return await relationsMethods[type]();\n\n  }\n\n  async solveInclude(item, include) {\n\n    if (Array.isArray(item)) {\n      for (var j = 0; j < item.length; j++) {\n        await this.solveInclude(item[j], include);\n      }\n      return item;\n    }\n\n    for (var i = 0; i < include.length; i++) {\n      var relation = include[i];\n      item[relation] = await this.findOrPickThroughRelation(item, relation);\n    }\n\n    return item;\n  }\n\n  on(event, callback) {\n    this.eventEmitter.on(event, callback);\n  }\n}\n\nmodule.exports = Collection;\n"]}