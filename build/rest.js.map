{"version":3,"sources":["../lib/rest.js"],"names":[],"mappings":"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","file":"rest.js","sourcesContent":["'use strict';\n\nconst router = require('koa-simple-router');\nconst compose = require('koa-compose');\n\nvar crudMiddlewares = require('./rest-middlewares/crud');\n\nvar relationsMiddlewares = {\n  belongsTo: require('./rest-middlewares/belongs-to'),\n  hasMany: require('./rest-middlewares/has-many'),\n  hasOne: require('./rest-middlewares/has-one'),\n  hasAndBelongsToMany: require('./rest-middlewares/has-and-belongs-to-many'),\n  hasManyThrough: require('./rest-middlewares/has-many-through')\n};\n\nclass Rest {\n\n  constructor(app) {\n\n    this.app = app;\n    this.routes = {};\n\n  }\n\n  boot(){\n    this.registerCollections(this.app.collections);\n  }\n\n  registerEndpoint({ collectionName, method, route, middlewares, description, action, relation }) {\n\n    var prefix = '/api/' + collectionName;\n\n    this.app.koa.use(router({prefix}, _ => {\n      _[method](route, compose(middlewares));\n    }));\n\n    this.routes[collectionName] = this.routes[collectionName] || [];\n\n    this.routes[collectionName].push({\n      method: method,\n      url: prefix + route,\n      description: description,\n      action: action,\n      relation: relation\n    });\n  }\n\n  registerCollections(collections) {\n    for (var collectionName in collections) {\n      var collection = collections[collectionName];\n\n      this.registerCrud(collection);\n\n      this.registerRelations(collection);\n    }\n  }\n\n  registerCrud(collection) {\n    crudMiddlewares(this, {collection});\n  }\n\n\n  registerRelations(collection) {\n    var relations = collection.schema.relations;\n    for (var relationName in relations) {\n\n      var relation = relations[relationName];\n      relation.name = relationName;\n\n      var middleware = relationsMiddlewares[relation.type];\n\n      if (!middleware) {\n        throw new Error(\"relation type \" + relationType + \" not valid\");\n      }\n\n      middleware(this, {\n        collections: this.app.collections,\n        collection: collection,\n        relation: relation\n      });\n\n    }\n  }\n\n\n\n}\n\nmodule.exports = Rest;\n"]}