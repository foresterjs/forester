{"version":3,"sources":["../../lib/rest-middlewares/belongs-to.js"],"names":[],"mappings":"AAAA,YAAY,CAAC;;;;;QAyBG,GAAG,GAAH,GAAG;;;;AAvBnB,MAAM,CAAC,OAAO,GAAG,UAAU,IAAI,QAAuC;MAApC,WAAW,QAAX,WAAW;MAAE,UAAU,QAAV,UAAU;MAAE,QAAQ,QAAR,QAAQ;;AAEjE,MAAI,iBAAiB,GAAG,WAAW,CAAC,QAAQ,CAAC,UAAU,CAAC,CAAC;AACzD,MAAI,UAAU,GAAG,QAAQ,CAAC,UAAU,CAAC;;AAErC,MAAI,CAAC,gBAAgB,CACnB;AACE,UAAM,EAAE,MAAM;AACd,YAAQ,EAAE,QAAQ,CAAC,IAAI;AACvB,kBAAc,EAAE,UAAU,CAAC,IAAI;AAC/B,UAAM,EAAE,KAAK;AACb,SAAK,EAAE,OAAO,GAAG,QAAQ,CAAC,IAAI;AAC9B,eAAW,EAAE,CACX,UAAU,CAAC,QAAQ,CAAC,GAAG,CAAC,MAAM,EAAE,QAAQ,CAAC,IAAI,CAAC,EAC9C,GAAG,CAAC,EAAC,UAAU,EAAE,iBAAiB,EAAE,UAAU,EAAC,CAAC,CACjD;AACD,eAAW,EAAE,OAAO,GAAG,QAAQ,CAAC,IAAI;GACrC,CACF,CAAC;CAEH,CAAA;;AAGM,SAAS,GAAG,QAA8C;MAA5C,UAAU,SAAV,UAAU;MAAE,iBAAiB,SAAjB,iBAAiB;MAAE,UAAU,SAAV,UAAU;;AAC5D;gCAAO,kBAA6C,IAAI,EAAE;UAAlC,OAAO,SAAP,OAAO;UAAE,QAAQ,SAAR,QAAQ;UAAE,MAAM,SAAN,MAAM;;AAE/C,UAAI,EAAE,GAAG,MAAM,CAAC,EAAE,CAAC;AACnB,cAAQ,CAAC,IAAI,GAAG,QAAQ,CAAC,IAAI,IAAI,EAAE;;;AAAC,AAGpC,UAAI,IAAI,GAAG,MAAM,UAAU,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;AACrC,UAAG,CAAC,IAAI,EAAC;AACP,gBAAQ,CAAC,IAAI,CAAC,IAAI,GAAG,KAAK,CAAC;AAC3B,gBAAQ,CAAC,IAAI,CAAC,MAAM,GAAG,CAAC,WAAW,CAAC,CAAC;AACrC,cAAM,IAAI,EAAE,CAAC;AACb,eAAO;OACR;;;AAAA,AAGD,UAAI,SAAS,GAAG,IAAI,CAAC,UAAU,CAAC,CAAC;AACjC,UAAG,CAAC,SAAS,EAAC;AACZ,gBAAQ,CAAC,IAAI,CAAC,IAAI,GAAG,KAAK,CAAC;AAC3B,gBAAQ,CAAC,IAAI,CAAC,MAAM,GAAG,CAAC,WAAW,CAAC,CAAC;AACrC,cAAM,IAAI,EAAE,CAAC;AACb,eAAO;OACR;;;AAAA,AAGD,UAAI,WAAW,GAAG,MAAM,iBAAiB,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;AAC1D,UAAG,WAAW,EAAC;AACb,gBAAQ,CAAC,IAAI,CAAC,IAAI,GAAG,IAAI,CAAC;AAC1B,gBAAQ,CAAC,IAAI,CAAC,IAAI,GAAG,WAAW,CAAC;OAClC,MAAI;AACH,gBAAQ,CAAC,IAAI,CAAC,IAAI,GAAG,KAAK,CAAC;AAC3B,gBAAQ,CAAC,IAAI,CAAC,MAAM,GAAG,CAAC,WAAW,CAAC,CAAC;OACtC;KACF;;;;;OAAA;CACF","file":"belongs-to.js","sourcesContent":["\"use strict\";\n\nmodule.exports = function (rest, {collections, collection, relation}) {\n\n  var foreignCollection = collections[relation.collection];\n  var foreignKey = relation.foreignKey;\n\n  rest.registerEndpoint(\n    {\n      action: \"pick\",\n      relation: relation.name,\n      collectionName: collection.name,\n      method: \"get\",\n      route: \"/:id/\" + relation.name,\n      middlewares: [\n        collection.defender.acl(\"pick\", relation.name),\n        get({collection, foreignCollection, foreignKey})\n      ],\n      description: \"pick \" + relation.name\n    }\n  );\n\n}\n\n\nexport function get({collection, foreignCollection, foreignKey}) {\n  return async function ({request, response, params}, next) {\n\n    var id = params.id;\n    response.body = response.body || {};\n\n    //pick obj\n    var item = await collection.pick(id);\n    if(!item){\n      response.body.done = false;\n      response.body.errors = ['not_found'];\n      await next();\n      return;\n    }\n\n    //check\n    var foreignId = item[foreignKey];\n    if(!foreignId){\n      response.body.done = false;\n      response.body.errors = ['not_found'];\n      await next();\n      return;\n    }\n\n    //pick foreign obj\n    var foreignItem = await foreignCollection.pick(foreignId);\n    if(foreignItem){\n      response.body.done = true;\n      response.body.data = foreignItem;\n    }else{\n      response.body.done = false;\n      response.body.errors = ['not_found'];\n    }\n  }\n}\n"]}