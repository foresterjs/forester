{"version":3,"sources":["../../lib/rest-middlewares/belongs-to.js"],"names":[],"mappings":"AAAA;;;;;QAyBgB,G,GAAA,G;;;;AAvBhB,OAAO,OAAP,GAAiB,UAAU,IAAV,QAAqD;AAAA,MAApC,WAAoC,QAApC,WAAoC;AAAA,MAAvB,UAAuB,QAAvB,UAAuB;AAAA,MAAX,QAAW,QAAX,QAAW;;;AAEpE,MAAI,oBAAoB,YAAY,SAAS,UAArB,CAAxB;AACA,MAAI,aAAa,SAAS,UAA1B;;AAEA,OAAK,gBAAL,CACE;AACE,YAAQ,MADV;AAEE,cAAU,SAAS,IAFrB;AAGE,oBAAgB,WAAW,IAH7B;AAIE,YAAQ,KAJV;AAKE,WAAO,UAAU,SAAS,IAL5B;AAME,iBAAa,CACX,WAAW,QAAX,CAAoB,GAApB,CAAwB,MAAxB,EAAgC,SAAS,IAAzC,CADW,EAEX,IAAI,EAAC,sBAAD,EAAa,oCAAb,EAAgC,sBAAhC,EAAJ,CAFW,CANf;AAUE,iBAAa,UAAU,SAAS;AAVlC,GADF;AAeD,CApBD;;AAuBO,SAAS,GAAT,QAA0D;AAAA,MAA5C,UAA4C,SAA5C,UAA4C;AAAA,MAAhC,iBAAgC,SAAhC,iBAAgC;AAAA,MAAb,UAAa,SAAb,UAAa;;AAC/D;AAAA,0DAAO,wBAA6C,IAA7C;AAAA,UAAiB,OAAjB,SAAiB,OAAjB;AAAA,UAA0B,QAA1B,SAA0B,QAA1B;AAAA,UAAoC,MAApC,SAAoC,MAApC;AAAA,UAED,EAFC,EAMD,IANC,EAeD,SAfC,EAwBD,WAxBC;AAAA;AAAA;AAAA;AAAA;AAED,gBAFC,GAEI,OAAO,EAFX;;AAGL,uBAAS,IAAT,GAAgB,SAAS,IAAT,IAAiB,EAAjC;;;AAHK;AAAA,qBAMY,WAAW,IAAX,CAAgB,EAAhB,CANZ;;AAAA;AAMD,kBANC;;AAAA,kBAOD,IAPC;AAAA;AAAA;AAAA;;AAQH,uBAAS,IAAT,CAAc,IAAd,GAAqB,KAArB;AACA,uBAAS,IAAT,CAAc,MAAd,GAAuB,CAAC,WAAD,CAAvB;AATG;AAAA,qBAUG,MAVH;;AAAA;AAAA;;AAAA;;;AAeD,uBAfC,GAeW,KAAK,UAAL,CAfX;;AAAA,kBAgBD,SAhBC;AAAA;AAAA;AAAA;;AAiBH,uBAAS,IAAT,CAAc,IAAd,GAAqB,KAArB;AACA,uBAAS,IAAT,CAAc,MAAd,GAAuB,CAAC,WAAD,CAAvB;AAlBG;AAAA,qBAmBG,MAnBH;;AAAA;AAAA;;AAAA;AAAA;AAAA,qBAwBmB,kBAAkB,IAAlB,CAAuB,SAAvB,CAxBnB;;AAAA;AAwBD,yBAxBC;;AAyBL,kBAAG,WAAH,EAAe;AACb,yBAAS,IAAT,CAAc,IAAd,GAAqB,IAArB;AACA,yBAAS,IAAT,CAAc,IAAd,GAAqB,WAArB;AACD,eAHD,MAGK;AACH,yBAAS,IAAT,CAAc,IAAd,GAAqB,KAArB;AACA,yBAAS,IAAT,CAAc,MAAd,GAAuB,CAAC,WAAD,CAAvB;AACD;;AA/BI;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAAP;;AAAA;AAAA;AAAA;AAAA;AAiCD","file":"belongs-to.js","sourcesContent":["\"use strict\";\n\nmodule.exports = function (rest, {collections, collection, relation}) {\n\n  var foreignCollection = collections[relation.collection];\n  var foreignKey = relation.foreignKey;\n\n  rest.registerEndpoint(\n    {\n      action: \"pick\",\n      relation: relation.name,\n      collectionName: collection.name,\n      method: \"get\",\n      route: \"/:id/\" + relation.name,\n      middlewares: [\n        collection.defender.acl(\"pick\", relation.name),\n        get({collection, foreignCollection, foreignKey})\n      ],\n      description: \"pick \" + relation.name\n    }\n  );\n\n}\n\n\nexport function get({collection, foreignCollection, foreignKey}) {\n  return async function ({request, response, params}, next) {\n\n    var id = params.id;\n    response.body = response.body || {};\n\n    //pick obj\n    var item = await collection.pick(id);\n    if(!item){\n      response.body.done = false;\n      response.body.errors = ['not_found'];\n      await next();\n      return;\n    }\n\n    //check\n    var foreignId = item[foreignKey];\n    if(!foreignId){\n      response.body.done = false;\n      response.body.errors = ['not_found'];\n      await next();\n      return;\n    }\n\n    //pick foreign obj\n    var foreignItem = await foreignCollection.pick(foreignId);\n    if(foreignItem){\n      response.body.done = true;\n      response.body.data = foreignItem;\n    }else{\n      response.body.done = false;\n      response.body.errors = ['not_found'];\n    }\n  }\n}\n"]}