{"version":3,"sources":["../../lib/rest-middlewares/crud.js"],"names":[],"mappings":"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","file":"crud.js","sourcesContent":["\"use strict\";\n\nvar commonMiddlewares = require('./common');\nconst ValidationFail = require('../validation-fail');\n\nmodule.exports = function (rest, {collection}) {\n\n  rest.registerEndpoint(\n    {\n      action: \"find\",\n      collectionName: collection.name,\n      method: \"get\",\n      route: \"/\",\n      middlewares: [\n        collection.defender.acl(\"find\"),\n        commonMiddlewares.showSchema({collection}),\n        commonMiddlewares.showCount({collection}),\n        commonMiddlewares.showPagesCount({collection}),\n        commonMiddlewares.showUser({collection}),\n        findAll({collection})],\n      description: \"find your elements\"\n    }\n  );\n\n  rest.registerEndpoint(\n    {\n      action: \"pick\",\n      collectionName: collection.name,\n      method: \"get\",\n      route: \"/:id\",\n      middlewares: [\n        collection.defender.acl(\"pick\"),\n        commonMiddlewares.showSchema({collection}),\n        pick({collection})\n      ],\n      description: \"find elements\"\n    }\n  );\n\n  rest.registerEndpoint(\n    {\n      action: \"create\",\n      collectionName: collection.name,\n      method: \"post\",\n      route: \"/\",\n      middlewares: [\n        collection.defender.acl(\"create\"),\n        create({collection})\n      ],\n      description: \"create an element\"\n    }\n  );\n\n  rest.registerEndpoint(\n    {\n      action: \"update\",\n      collectionName: collection.name,\n      method: \"put\",\n      route: \"/:id\",\n      middlewares: [\n        collection.defender.acl(\"update\"),\n        update({collection})\n      ],\n      description: \"update an element\"\n    }\n  );\n\n  rest.registerEndpoint(\n    {\n      action: \"destroy\",\n      collectionName: collection.name,\n      method: \"delete\",\n      route: \"/:id\",\n      middlewares: [\n        collection.defender.acl(\"destroy\"),\n        destroy({collection})\n      ],\n      description: \"delete an element\"\n    }\n  );\n\n};\n\n\nexport function findAll({collection}) {\n  return async function ({request, response}, next) {\n    var options = request.query;\n    response.body = response.body || {};\n\n    var items = await collection.findAll(options);\n\n    response.body.data = items;\n    response.body.done = true;\n\n    await next();\n  }\n}\n\nexport function pick({collection}) {\n  return async function ({request, response, params}, next) {\n    var id = params.id;\n    response.body = response.body || {};\n\n    var item = await collection.pick(id);\n\n\n    if (item) {\n      response.body.data = item;\n      response.body.done = true;\n    } else {\n      response.body.done = false;\n      response.body.errors = ['not_found'];\n    }\n\n    await next();\n  }\n}\n\nexport function create({collection}) {\n  return async function ({request, response}, next) {\n\n    var data = request.body;\n\n    response.body = response.body || {};\n\n    try{\n      var item = await collection.create(data);\n      response.body.data = item;\n      response.body.done = true;\n      await next();\n\n    }catch (err){\n      if(err instanceof ValidationFail){\n\n        response.body.errors = err.errors;\n        response.body.done = false;\n        await next();\n        return;\n      }\n\n      throw err;\n    }\n\n  }\n}\n\nexport function update({collection}) {\n  return async function ({request, response, params}, next) {\n\n    var id = params.id;\n    var data = request.body;\n    response.body = response.body || {};\n\n    try{\n      var item = await collection.update(id, data);\n\n      if (item) {\n        response.body.data = item;\n        response.body.done = true;\n      } else {\n        response.body.done = false;\n        response.body.errors = ['not_found'];\n      }\n\n      await next();\n\n    }catch (err){\n\n      if(err instanceof ValidationFail){\n\n        response.body.errors = err.errors;\n        response.body.done = false;\n        await next();\n        return;\n      }\n\n      throw err;\n    }\n  }\n}\n\nexport function destroy({collection}) {\n  return async function ({request, response, params}, next) {\n\n    var id = params.id;\n    response.body = response.body || {};\n\n    var result = await collection.destroy(id);\n\n    response.body.done = result;\n\n    if (!result) response.body.errors = ['not_found'];\n\n    await next();\n  }\n}\n"]}