{"version":3,"sources":["../../lib/rest-middlewares/crud.js"],"names":[],"mappings":"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","file":"crud.js","sourcesContent":["\"use strict\";\n\nvar commonMiddlewares = require('./common');\nconst ValidationFail = require('../validation-fail');\n\nmodule.exports = function (rest, {collection}) {\n\n  rest.registerEndpoint(\n    {\n      action: \"find\",\n      collectionName: collection.name,\n      method: \"get\",\n      route: \"/\",\n      middlewares: [\n        collection.defender.acl(\"find\"),\n        commonMiddlewares.showSchema({collection}),\n        commonMiddlewares.showCount({collection}),\n        commonMiddlewares.showPagesCount({collection}),\n        commonMiddlewares.showUser({collection}),\n        findAll({collection})],\n      description: \"find your elements\"\n    }\n  );\n\n  rest.registerEndpoint(\n    {\n      action: \"pick\",\n      collectionName: collection.name,\n      method: \"get\",\n      route: \"/:id\",\n      middlewares: [\n        collection.defender.acl(\"pick\"),\n        commonMiddlewares.showSchema({collection}),\n        pick({collection})\n      ],\n      description: \"find elements\"\n    }\n  );\n\n  rest.registerEndpoint(\n    {\n      action: \"create\",\n      collectionName: collection.name,\n      method: \"post\",\n      route: \"/\",\n      middlewares: [\n        collection.defender.acl(\"create\"),\n        create({collection})\n      ],\n      description: \"create an element\"\n    }\n  );\n\n  rest.registerEndpoint(\n    {\n      action: \"update\",\n      collectionName: collection.name,\n      method: \"put\",\n      route: \"/:id\",\n      middlewares: [\n        collection.defender.acl(\"update\"),\n        update({collection})\n      ],\n      description: \"update an element\"\n    }\n  );\n\n  rest.registerEndpoint(\n    {\n      action: \"destroy\",\n      collectionName: collection.name,\n      method: \"delete\",\n      route: \"/:id\",\n      middlewares: [\n        collection.defender.acl(\"destroy\"),\n        destroy({collection})\n      ],\n      description: \"delete an element\"\n    }\n  );\n\n};\n\n\nexport function findAll({collection}) {\n  return async function ({request, response}, next) {\n    var options = request.query;\n    response.body = response.body || {};\n\n    var items = await collection.findAll(options);\n\n    response.body.data = items;\n    response.body.done = true;\n\n    await next();\n  }\n}\n\nexport function pick({collection}) {\n  return async function ({request, response, params}, next) {\n    var id = params.id;\n    var include = request.query.include || {};\n    response.body = response.body || {};\n\n    var item = await collection.pick(id, {include});\n\n    if (item) {\n      response.body.data = item;\n      response.body.done = true;\n    } else {\n      response.body.done = false;\n      response.body.errors = ['not_found'];\n    }\n\n    await next();\n  }\n}\n\nexport function create({collection}) {\n  return async function ({request, response}, next) {\n\n    var data = request.body;\n\n    response.body = response.body || {};\n\n    try{\n      var item = await collection.create(data);\n      response.body.data = item;\n      response.body.done = true;\n      await next();\n\n    }catch (err){\n      if(err instanceof ValidationFail){\n\n        response.body.errors = err.errors;\n        response.body.done = false;\n        await next();\n        return;\n      }\n\n      throw err;\n    }\n\n  }\n}\n\nexport function update({collection}) {\n  return async function ({request, response, params}, next) {\n\n    var id = params.id;\n    var data = request.body;\n    response.body = response.body || {};\n\n    try{\n      var item = await collection.update(id, data);\n\n      if (item) {\n        response.body.data = item;\n        response.body.done = true;\n      } else {\n        response.body.done = false;\n        response.body.errors = ['not_found'];\n      }\n\n      await next();\n\n    }catch (err){\n\n      if(err instanceof ValidationFail){\n\n        response.body.errors = err.errors;\n        response.body.done = false;\n        await next();\n        return;\n      }\n\n      throw err;\n    }\n  }\n}\n\nexport function destroy({collection}) {\n  return async function ({request, response, params}, next) {\n\n    var id = params.id;\n    response.body = response.body || {};\n\n    var result = await collection.destroy(id);\n\n    response.body.done = result;\n\n    if (!result) response.body.errors = ['not_found'];\n\n    await next();\n  }\n}\n"]}