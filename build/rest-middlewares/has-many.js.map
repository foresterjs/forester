{"version":3,"sources":["../../lib/rest-middlewares/has-many.js"],"names":[],"mappings":"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","file":"has-many.js","sourcesContent":["\"use strict\";\n\nconst ValidationFail = require('../validation-fail');\n\nmodule.exports = function (rest, {collections, collection, relation}) {\n\n  var foreignCollection = collections[relation.collection];\n  var foreignKey = relation.foreignKey;\n\n  rest.registerEndpoint(\n    {\n      action: \"find\",\n      relation: relation.name,\n      collectionName: collection.name,\n      method: \"get\",\n      route: \"/:id/\" + relation.name,\n      middlewares: [\n        collection.defender.acl(\"find\", relation.name),\n        find({collection, foreignCollection, foreignKey})\n      ],\n      description: \"get \" + relation.name\n    }\n  );\n\n  rest.registerEndpoint(\n    {\n      action: \"pick\",\n      relation: relation.name,\n      collectionName: collection.name,\n      method: \"get\",\n      route: '/:id/' + relation.name + '/:fk',\n      middlewares: [\n        collection.defender.acl(\"pick\", relation.name),\n        pick({collection, foreignCollection, foreignKey})\n      ],\n      description: \"get \" + relation.name\n    }\n  );\n\n  rest.registerEndpoint(\n    {\n      action: \"create\",\n      relation: relation.name,\n      collectionName: collection.name,\n      method: \"post\",\n      route: '/:id/' + relation.name,\n      middlewares: [\n        collection.defender.acl(\"create\", relation.name),\n        create({collection, foreignCollection, foreignKey})\n      ],\n      description: \"create \" + relation.name\n    }\n  );\n\n  rest.registerEndpoint(\n    {\n      action: \"update\",\n      relation: relation.name,\n      collectionName: collection.name,\n      method: \"put\",\n      route: '/:id/' + relation.name + '/:fk',\n      middlewares: [\n        collection.defender.acl(\"update\", relation.name),\n        update({collection, foreignCollection, foreignKey})\n      ],\n      description: \"create \" + relation.name\n    }\n  );\n\n  rest.registerEndpoint(\n    {\n      action: \"destroy\",\n      relation: relation.name,\n      collectionName: collection.name,\n      method: \"delete\",\n      route: '/:id/' + relation.name + '/:fk',\n      middlewares: [\n        collection.defender.acl(\"destroy\", relation.name),\n        destroy({collection, foreignCollection, foreignKey})\n      ],\n      description: \"destroy \" + relation.name\n    }\n  );\n}\n\n\nexport function find({collection, foreignCollection, foreignKey}) {\n  return async function ({request, response, params}, next) {\n\n    var id = params.id;\n    var options = request.query;\n    response.body = response.body || {};\n\n    options.where = options.where || {};\n    options.where[foreignKey] = id;\n\n    var items = await foreignCollection.findAll(options);\n\n    response.body.data = items;\n    response.body.done = true;\n\n\n    await next();\n  }\n}\n\n\nexport function pick({collection, foreignCollection, foreignKey}) {\n  return async function ({request, response, params}, next) {\n    var id = params.id;\n    var fk = params.fk;\n    response.body = response.body || {};\n\n    var item = await foreignCollection.pick(fk);\n\n\n    if (item && item[foreignKey] === id) {\n      response.body.data = item;\n      response.body.done = true;\n    } else {\n      response.body.done = false;\n      response.body.errors = ['not_found'];\n    }\n\n    await next();\n  }\n}\n\nexport function create({collection, foreignCollection, foreignKey}) {\n  return async function ({request, response, params}, next) {\n\n    var id = params.id;\n    var data = request.body;\n    response.body = response.body || {};\n\n    data[foreignKey] = id;\n\n    try {\n      var item = await foreignCollection.create(data);\n\n      if (item) {\n        response.body.data = item;\n        response.body.done = true;\n      } else {\n        response.body.done = false;\n        response.body.errors = ['not_saved'];\n      }\n\n      await next();\n\n    } catch (err) {\n      if (err instanceof ValidationFail) {\n\n        response.body.errors = err.errors;\n        response.body.done = false;\n        await next();\n        return;\n      }\n\n      throw err;\n    }\n  }\n}\n\nexport function update({collection, foreignCollection, foreignKey}) {\n  return async function ({request, response, params}, next) {\n\n    var id = params.id;\n    var fk = params.fk;\n    var data = request.body;\n    response.body = response.body || {};\n\n    data[foreignKey] = id;\n\n    //check\n    var item = await foreignCollection.pick(fk);\n    if (!item[foreignKey] === id) {\n      request.body.done = false;\n      request.body.errors = ['not_found', 'not_saved'];\n      await next();\n      return;\n    }\n\n    //update\n    try {\n      var item = await foreignCollection.update(fk, data);\n      if (item) {\n        response.body.data = item;\n        response.body.done = true;\n      } else {\n        response.body.done = false;\n        response.body.errors = ['not_saved'];\n      }\n      await next();\n\n    } catch (err) {\n      if (err instanceof ValidationFail) {\n\n        response.body.errors = err.errors;\n        response.body.done = false;\n        await next();\n        return;\n      }\n\n      throw err;\n    }\n  }\n}\n\nexport function destroy({collection, foreignCollection, foreignKey}) {\n  return async function ({request, response, params}, next) {\n    var id = params.id;\n    var fk = params.fk;\n    response.body = response.body || {};\n\n    //check\n    var item = await foreignCollection.pick(fk);\n    if (!(item && item[foreignKey] === id)) {\n      response.body.done = false;\n      response.body.errors = ['not_found'];\n      await next();\n      return;\n    }\n\n    //delete\n    var result = await foreignCollection.destroy(fk);\n    response.body.done = result;\n    await next();\n  }\n}\n"]}