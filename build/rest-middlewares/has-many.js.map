{"version":3,"sources":["../../lib/rest-middlewares/has-many.js"],"names":[],"mappings":"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","file":"has-many.js","sourcesContent":["\"use strict\";\n\nconst ValidationFail = require('../validation-fail');\n\nmodule.exports = function (rest, {collections, collection, relation}) {\n\n  var foreignCollection = collections[relation.collection];\n  var foreignKey = relation.foreignKey;\n\n  rest.registerEndpoint(\n    {\n      action: \"find\",\n      relation: relation.name,\n      collectionName: collection.name,\n      method: \"get\",\n      route: \"/:id/\" + relation.name,\n      middlewares: [\n        collection.defender.acl(\"find\", relation.name),\n        find({collection, foreignCollection, foreignKey})\n      ],\n      description: \"get \" + relation.name\n    }\n  );\n\n  rest.registerEndpoint(\n    {\n      action: \"pick\",\n      relation: relation.name,\n      collectionName: collection.name,\n      method: \"get\",\n      route: '/:id/' + relation.name + '/:fk',\n      middlewares: [\n        collection.defender.acl(\"pick\", relation.name),\n        pick({collection, foreignCollection, foreignKey})\n      ],\n      description: \"get \" + relation.name\n    }\n  );\n\n  rest.registerEndpoint(\n    {\n      action: \"create\",\n      relation: relation.name,\n      collectionName: collection.name,\n      method: \"post\",\n      route: '/:id/' + relation.name,\n      middlewares: [\n        collection.defender.acl(\"create\", relation.name),\n        create({collection, foreignCollection, foreignKey})\n      ],\n      description: \"create \" + relation.name\n    }\n  );\n\n  rest.registerEndpoint(\n    {\n      action: \"update\",\n      relation: relation.name,\n      collectionName: collection.name,\n      method: \"put\",\n      route: '/:id/' + relation.name + '/:fk',\n      middlewares: [\n        collection.defender.acl(\"update\", relation.name),\n        update({collection, foreignCollection, foreignKey})\n      ],\n      description: \"create \" + relation.name\n    }\n  );\n\n  rest.registerEndpoint(\n    {\n      action: \"destroy\",\n      relation: relation.name,\n      collectionName: collection.name,\n      method: \"delete\",\n      route: '/:id/' + relation.name + '/:fk',\n      middlewares: [\n        collection.defender.acl(\"destroy\", relation.name),\n        destroy({collection, foreignCollection, foreignKey})\n      ],\n      description: \"destroy \" + relation.name\n    }\n  );\n}\n\n\nexport function find({collection, foreignCollection, foreignKey}) {\n  return async function ({request, response, params}, next) {\n\n    var id = params.id;\n    var options = request.query;\n    response.body = response.body || {};\n\n    options.where = options.where || {};\n    options.where[foreignKey] = id;\n\n    var items = await foreignCollection.findAll(options);\n\n    response.body.data = items;\n    response.body.done = true;\n\n\n    await next();\n  }\n}\n\n\nexport function pick({collection, foreignCollection, foreignKey}) {\n  return async function ({request, response, params}, next) {\n    var id = params.id;\n    var fk = params.fk;\n    response.body = response.body || {};\n\n    var item = await foreignCollection.pick(fk);\n\n\n    if (item && item[foreignKey] === id) {\n      response.body.data = item;\n      response.body.done = true;\n    } else {\n      response.body.done = false;\n      response.body.errors = ['not_found'];\n    }\n\n    await next();\n  }\n}\n\nexport function create({collection, foreignCollection, foreignKey}) {\n  return async function ({request, response, params}, next) {\n\n    var id = params.id;\n    var data = request.body;\n    response.body = response.body || {};\n\n    data[foreignKey] = id;\n\n    try {\n      var item = await foreignCollection.create(data);\n\n      if (item) {\n        response.body.data = item;\n        response.body.done = true;\n      } else {\n        response.body.done = false;\n        response.body.errors = ['not_saved'];\n      }\n\n      await next();\n\n    } catch (err) {\n      if (err instanceof ValidationFail) {\n\n        response.body.errors = err.errors;\n        response.body.done = false;\n        await next();\n        return;\n      }\n\n      throw err;\n    }\n  }\n}\n\nexport function update({collection, foreignCollection, foreignKey}) {\n  return async function ({request, response, params}, next) {\n\n    var id = params.id;\n    var fk = params.fk;\n    var data = request.body;\n    response.body = response.body || {};\n\n    data[foreignKey] = id;\n\n    //check\n    var item = await foreignCollection.pick(fk);\n    if (!item[foreignKey] === id) {\n      request.body.done = false;\n      request.body.errors = ['not_found', 'not_saved'];\n      await next();\n      return;\n    }\n\n    //update\n    try {\n      var item = await foreignCollection.update(fk, data);\n      if (item) {\n        response.body.data = item;\n        response.body.done = true;\n      } else {\n        response.body.done = false;\n        response.body.errors = ['not_saved'];\n      }\n      await next();\n\n    } catch (err) {\n      if (err instanceof ValidationFail) {\n\n        response.body.errors = err.errors;\n        response.body.done = false;\n        await next();\n        return;\n      }\n\n      throw err;\n    }\n  }\n}\n\nexport function destroy({collection, foreignCollection, foreignKey}) {\n  return async function ({request, response, params}, next) {\n    var id = params.id;\n    var fk = params.fk;\n    response.body = response.body || {};\n\n    //check\n    var item = await foreignCollection.pick(fk);\n    if (!(item && item[foreignKey] === id)) {\n      response.body.done = false;\n      response.body.errors = ['not_found'];\n      await next();\n      return;\n    }\n\n    //delete\n    var result = await foreignCollection.destroy(fk);\n    response.body.done = result;\n    await next();\n  }\n}\n"]}