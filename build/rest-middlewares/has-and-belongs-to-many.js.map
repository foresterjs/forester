{"version":3,"sources":["../../lib/rest-middlewares/has-and-belongs-to-many.js"],"names":[],"mappings":"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","file":"has-and-belongs-to-many.js","sourcesContent":["\"use strict\";\nconst ValidationFail = require('../validation-fail');\n\nmodule.exports = function (rest, {collections, collection, relation}) {\n\n\n  var foreignCollection = collections[relation.collection];\n  var foreignKey = relation.foreignKey;\n  var key = relation.key;\n  var throughCollection = collections[relation.through];\n\n  rest.registerEndpoint(\n    {\n      action: \"find\",\n      relation: relation.name,\n      collectionName: collection.name,\n      method: \"get\",\n      route: '/:id/' + relation.name,\n      middlewares: [\n        collection.defender.acl(\"find\", relation.name),\n        find({\n          collection,\n          foreignCollection,\n          throughCollection,\n          key,\n          foreignKey\n        })],\n      description: \"find all \" + relation.name\n    }\n  );\n\n  rest.registerEndpoint(\n    {\n      action: \"addAssociation\",\n      relation: relation.name,\n      collectionName: collection.name,\n      method: \"post\",\n      route: '/:id/' + relation.name + '/:fk',\n      middlewares: [\n        collection.defender.acl(\"addAssociation\", relation.name),\n        addAssociation({\n          collection,\n          foreignCollection,\n          throughCollection,\n          key,\n          foreignKey\n        })],\n      description: \"add association with \" + relation.name\n    }\n  );\n\n  rest.registerEndpoint(\n    {\n      action: \"destroyAssociation\",\n      relation: relation.name,\n      collectionName: collection.name,\n      method: \"delete\",\n      route: '/:id/' + relation.name + '/:fk',\n      middlewares: [\n        collection.defender.acl(\"destroyAssociation\", relation.name),\n        destroyAssociation({\n          collection,\n          foreignCollection,\n          throughCollection,\n          key,\n          foreignKey\n        })],\n      description: \"remove association with \" + relation.name\n    }\n  );\n}\n\nexport function find({collection, foreignCollection, throughCollection, foreignKey, key}) {\n  return async function ({request, response, params}, next) {\n\n    var id = params.id;\n    response.body = response.body || {};\n\n    //TODO add check not found\n\n    var joinList = await throughCollection.findAll({\n      where: {\n        [key]: id\n      }\n    });\n\n    var ids = joinList.map(function (item) {\n      return item[foreignKey];\n    });\n\n    var items = await foreignCollection.pick(ids);\n\n    response.body.data = items;\n    response.body.done = true;\n\n    await next();\n  }\n}\n\nexport function addAssociation({collection, foreignCollection, throughCollection, foreignKey, key}) {\n  return async function ({request, response, params}, next) {\n\n    var id = params.id;\n    var fk = params.fk;\n    response.body = response.body || {};\n\n    var existsItem = await collection.exists(id);\n    var existsForeignItem = await foreignCollection.exists(fk);\n\n    if (!existsItem || !existsForeignItem) {\n      response.body.done = false;\n      response.body.errors = ['not_found'];\n      await next();\n      return;\n    }\n\n    var joinList = await throughCollection.findAll({\n      where: {\n        [key]: id,\n        [foreignKey]: fk\n      }\n    });\n\n    if (joinList.length > 0) {\n      response.body.done = false;\n      response.body.errors = ['too_many'];\n      await next();\n      return;\n    }\n\n    try {\n      var item = await throughCollection.create(\n        {\n          [key]: id,\n          [foreignKey]: fk\n        });\n\n      response.body.data = item;\n      response.body.done = true;\n\n    } catch (err) {\n      if (err instanceof ValidationFail) {\n\n        response.body.errors = err.errors;\n        response.body.done = false;\n        await next();\n        return;\n      }\n\n      throw err;\n    }\n\n    await next();\n  }\n}\n\nexport function destroyAssociation({collection, foreignCollection, throughCollection, foreignKey, key}) {\n  return async function ({request, response, params}, next) {\n\n    var id = params.id;\n    var fk = params.fk;\n    response.body = response.body || {};\n\n    var joinList = await throughCollection.findAll({\n      where: {\n        [key]: id,\n        [foreignKey]: fk\n      }\n    });\n\n    if (joinList.length === 0) {\n      response.body.done = false;\n      response.body.errors = ['not_found'];\n      await next();\n      return;\n    }\n\n    var ids = joinList.map(function (item) {\n      return item.id;\n    });\n\n    var result = await throughCollection.destroy(ids);\n\n    response.body.done = result;\n\n    return next;\n  }\n\n}\n\n\n"]}