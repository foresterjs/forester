{"version":3,"sources":["../../lib/rest-middlewares/has-and-belongs-to-many.js"],"names":[],"mappings":"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","file":"has-and-belongs-to-many.js","sourcesContent":["\"use strict\";\n\nmodule.exports = function (rest, {collections, collection, relation}) {\n\n\n  var foreignCollection = collections[relation.collection];\n  var foreignKey = relation.foreignKey;\n  var key = relation.key;\n  var throughCollection = collections[relation.through];\n\n  rest.registerEndpoint(\n    {\n      action: \"find\",\n      relation: relation.name,\n      collectionName: collection.name,\n      method: \"get\",\n      route: '/:id/' + relation.name,\n      middlewares: [\n        collection.defender.acl(\"find\", relation.name),\n        find({\n          collection,\n          foreignCollection,\n          throughCollection,\n          key,\n          foreignKey\n        })],\n      description: \"find all \" + relation.name\n    }\n  );\n\n  rest.registerEndpoint(\n    {\n      action: \"addAssociation\",\n      relation: relation.name,\n      collectionName: collection.name,\n      method: \"post\",\n      route: '/:id/' + relation.name + '/:fk',\n      middlewares: [\n        collection.defender.acl(\"addAssociation\", relation.name),\n        addAssociation({\n          collection,\n          foreignCollection,\n          throughCollection,\n          key,\n          foreignKey\n        })],\n      description: \"add association with \" + relation.name\n    }\n  );\n\n  rest.registerEndpoint(\n    {\n      action: \"destroyAssociation\",\n      relation: relation.name,\n      collectionName: collection.name,\n      method: \"delete\",\n      route: '/:id/' + relation.name + '/:fk',\n      middlewares: [\n        collection.defender.acl(\"destroyAssociation\", relation.name),\n        destroyAssociation({\n          collection,\n          foreignCollection,\n          throughCollection,\n          key,\n          foreignKey\n        })],\n      description: \"remove association with \" + relation.name\n    }\n  );\n}\n\nexport function find({collection, foreignCollection, throughCollection, foreignKey, key}) {\n  return async function ({request, response, params}, next) {\n\n    var id = params.id;\n    response.body = response.body || {};\n\n    //TODO add check not found\n\n    var joinList = await throughCollection.findAll({\n      where: {\n        [key]: id\n      }\n    });\n\n    var ids = joinList.map(function (item) {\n      return item[foreignKey];\n    });\n\n    var items = await foreignCollection.pick(ids);\n\n    response.body.data = items;\n    response.body.done = true;\n\n    await next();\n  }\n}\n\nexport function addAssociation({collection, foreignCollection, throughCollection, foreignKey, key}) {\n  return async function ({request, response, params}, next) {\n\n    var id = params.id;\n    var fk = params.fk;\n    response.body = response.body || {};\n\n    var existsItem = await collection.exists(id);\n    var existsForeignItem = await foreignCollection.exists(fk);\n\n    if (!existsItem || !existsForeignItem) {\n      response.body.done = false;\n      response.body.errors = ['not_found'];\n      await next();\n      return;\n    }\n\n    var joinList = await throughCollection.findAll({\n      where: {\n        [key]: id,\n        [foreignKey]: fk\n      }\n    });\n\n    if (joinList.length > 0) {\n      response.body.done = false;\n      response.body.errors = ['too_many'];\n      await next();\n      return;\n    }\n\n    var item = await throughCollection.create(\n      {\n        [key]: id,\n        [foreignKey]: fk\n      });\n\n    response.body.data = item;\n    response.body.done = true;\n\n    await next();\n  }\n}\n\nexport function destroyAssociation({collection, foreignCollection, throughCollection, foreignKey, key}) {\n  return async function ({request, response, params}, next) {\n\n    var id = params.id;\n    var fk = params.fk;\n    response.body = response.body || {};\n\n    var joinList = await throughCollection.findAll({\n      where: {\n        [key]: id,\n        [foreignKey]: fk\n      }\n    });\n\n    if (joinList.length === 0) {\n      response.body.done = false;\n      response.body.errors = ['not_found'];\n      await next();\n      return;\n    }\n\n    var ids = joinList.map(function (item) {\n      return item.id;\n    });\n\n    var result = await throughCollection.destroy(ids);\n\n    response.body.done = result;\n\n    return next;\n  }\n\n}\n\n\n"]}