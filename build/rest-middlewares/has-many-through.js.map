{"version":3,"sources":["../../lib/rest-middlewares/has-many-through.js"],"names":[],"mappings":"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","file":"has-many-through.js","sourcesContent":["\"use strict\";\n\nconst ValidationFail = require('../validation-fail');\n\nmodule.exports = function (rest, {collections, collection, relation}) {\n\n  var foreignCollection = collections[relation.collection];\n  var foreignKey = relation.foreignKey;\n  var key = relation.key;\n  var throughCollection = collections[relation.through];\n\n  rest.registerEndpoint(\n    {\n      action: \"find\",\n      relation: relation.name,\n      collectionName: collection.name,\n      method: \"get\",\n      route: '/:id/' + relation.name,\n      middlewares: [\n        collection.defender.acl(\"find\", relation.name),\n        find({\n          collection,\n          foreignCollection,\n          throughCollection,\n          key,\n          foreignKey\n        })],\n      description: \"find all \" + relation.name + \" about an \" + collection.name\n    }\n  );\n\n  rest.registerEndpoint(\n    {\n      action: \"findOn\",\n      relation: relation.name,\n      collectionName: collection.name,\n      method: \"get\",\n      route: '/:id/' + relation.name + '/:fk/',\n      middlewares: [\n        collection.defender.acl(\"findOn\", relation.name),\n        findOn({\n          collection,\n          foreignCollection,\n          throughCollection,\n          key,\n          foreignKey\n        })],\n      description: \"find all \" + relation.name + \" about an \" + collection.name + \" on a \" + foreignCollection.name\n    }\n  );\n\n  rest.registerEndpoint(\n    {\n      action: \"create\",\n      relation: relation.name,\n      collectionName: collection.name,\n      method: \"post\",\n      route: '/:id/' + relation.name + '/:fk',\n      middlewares: [\n        collection.defender.acl(\"create\", relation.name),\n        create({\n          collection,\n          foreignCollection,\n          throughCollection,\n          key,\n          foreignKey\n        })],\n      description: \"add a \" + relation.name\n    }\n  );\n\n  rest.registerEndpoint(\n    {\n      action: \"destroy\",\n      relation: relation.name,\n      collectionName: collection.name,\n      method: \"delete\",\n      route: '/:id/' + relation.name + '/:fk',\n      middlewares: [\n        collection.defender.acl(\"destroy\", relation.name),\n        destroy({\n          collection,\n          foreignCollection,\n          throughCollection,\n          key,\n          foreignKey\n        })],\n      description: \"remove all \" + relation.name + \" about an \" + collection.name\n    }\n  );\n}\n\nexport function find({collection, foreignCollection, throughCollection, foreignKey, key}) {\n  return async function ({request, response, params}, next) {\n\n    var id = params.id;\n    response.body = response.body || {};\n\n    var items = await throughCollection.findAll({\n      where: {\n        [key]: id\n      }\n    });\n\n    response.body.done = true;\n    response.body.data = items;\n\n    await next();\n  }\n}\n\nexport function findOn({collection, foreignCollection, throughCollection, foreignKey, key}) {\n  return async function ({request, response, params}, next) {\n\n    var id = params.id;\n    var fk = params.fk;\n    response.body = response.body || {};\n\n    var items = await throughCollection.findAll({\n      where: {\n        [key]: id,\n        [foreignKey]: fk\n      }\n    });\n\n    response.body.done = true;\n    response.body.data = items;\n\n    await next();\n\n  }\n}\n\nexport function create({collection, foreignCollection, throughCollection, foreignKey, key}) {\n  return async function ({request, response, params}, next) {\n\n    var id = params.id;\n    var fk = params.fk;\n    var data = request.body;\n    response.body = response.body || {};\n\n    var existsItem = await collection.exists(id);\n    var existsForeignItem = await foreignCollection.exists(fk);\n\n    if (!existsItem || !existsForeignItem) {\n      response.body.done = false;\n      response.body.errors = ['not_found'];\n      await next();\n      return;\n    }\n\n    data[key] = id;\n    data[foreignKey] = fk;\n\n    try {\n      var item = await throughCollection.create(data);\n      response.body.done = true;\n      response.body.data = item;\n\n      await next();\n    } catch (err) {\n      if (err instanceof ValidationFail) {\n\n        response.body.errors = err.errors;\n        response.body.done = false;\n        await next();\n        return;\n      }\n\n      throw err;\n    }\n  }\n}\n\nexport function destroy({collection, foreignCollection, throughCollection, foreignKey, key}) {\n  return async function ({request, response, params}, next) {\n\n    var id = params.id;\n    var fk = params.fk;\n    response.body = response.body || {};\n\n    var joinList = await throughCollection.findAll({\n      where: {\n        [key]: id,\n        [foreignKey]: fk\n      }\n    });\n\n    if (joinList.length === 0) {\n      response.body.done = false;\n      response.body.errors = ['not_found'];\n      await next();\n      return;\n    }\n\n    var ids = joinList.map(function (item) {\n      return item.id;\n    });\n\n    var result = await throughCollection.destroy(ids);\n    response.body.done = result;\n\n    await next();\n  }\n\n}\n\n\n"]}