{"version":3,"sources":["../../lib/rest-middlewares/has-many-through.js"],"names":[],"mappings":"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","file":"has-many-through.js","sourcesContent":["\"use strict\";\n\nconst ValidationFail = require('../validation-fail');\n\nmodule.exports = function (rest, {collections, collection, relation}) {\n\n  var foreignCollection = collections[relation.collection];\n  var foreignKey = relation.foreignKey;\n  var key = relation.key;\n  var throughCollection = collections[relation.through];\n\n  rest.registerEndpoint(\n    {\n      action: \"find\",\n      relation: relation.name,\n      collectionName: collection.name,\n      method: \"get\",\n      route: '/:id/' + relation.name,\n      middlewares: [\n        collection.defender.acl(\"find\", relation.name),\n        find({\n          collection,\n          foreignCollection,\n          throughCollection,\n          key,\n          foreignKey\n        })],\n      description: \"find all \" + relation.name + \" about an \" + collection.name\n    }\n  );\n\n  rest.registerEndpoint(\n    {\n      action: \"findOn\",\n      relation: relation.name,\n      collectionName: collection.name,\n      method: \"get\",\n      route: '/:id/' + relation.name + '/:fk/',\n      middlewares: [\n        collection.defender.acl(\"findOn\", relation.name),\n        findOn({\n          collection,\n          foreignCollection,\n          throughCollection,\n          key,\n          foreignKey\n        })],\n      description: \"find all \" + relation.name + \" about an \" + collection.name + \" on a \" + foreignCollection.name\n    }\n  );\n\n  rest.registerEndpoint(\n    {\n      action: \"create\",\n      relation: relation.name,\n      collectionName: collection.name,\n      method: \"post\",\n      route: '/:id/' + relation.name + '/:fk',\n      middlewares: [\n        collection.defender.acl(\"create\", relation.name),\n        create({\n          collection,\n          foreignCollection,\n          throughCollection,\n          key,\n          foreignKey\n        })],\n      description: \"add a \" + relation.name\n    }\n  );\n\n  rest.registerEndpoint(\n    {\n      action: \"destroy\",\n      relation: relation.name,\n      collectionName: collection.name,\n      method: \"delete\",\n      route: '/:id/' + relation.name + '/:fk',\n      middlewares: [\n        collection.defender.acl(\"destroy\", relation.name),\n        destroy({\n          collection,\n          foreignCollection,\n          throughCollection,\n          key,\n          foreignKey\n        })],\n      description: \"remove all \" + relation.name + \" about an \" + collection.name\n    }\n  );\n}\n\nexport function find({collection, foreignCollection, throughCollection, foreignKey, key}) {\n  return async function ({request, response, params}, next) {\n\n    var id = params.id;\n    response.body = response.body || {};\n\n    var items = await throughCollection.findAll({\n      where: {\n        [key]: id\n      }\n    });\n\n    response.body.done = true;\n    response.body.data = items;\n\n    await next();\n  }\n}\n\nexport function findOn({collection, foreignCollection, throughCollection, foreignKey, key}) {\n  return async function ({request, response, params}, next) {\n\n    var id = params.id;\n    var fk = params.fk;\n    response.body = response.body || {};\n\n    var items = await throughCollection.findAll({\n      where: {\n        [key]: id,\n        [foreignKey]: fk\n      }\n    });\n\n    response.body.done = true;\n    response.body.data = items;\n\n    await next();\n\n  }\n}\n\nexport function create({collection, foreignCollection, throughCollection, foreignKey, key}) {\n  return async function ({request, response, params}, next) {\n\n    var id = params.id;\n    var fk = params.fk;\n    var data = request.body;\n    response.body = response.body || {};\n\n    var existsItem = await collection.exists(id);\n    var existsForeignItem = await foreignCollection.exists(fk);\n\n    if (!existsItem || !existsForeignItem) {\n      response.body.done = false;\n      response.body.errors = ['not_found'];\n      await next();\n      return;\n    }\n\n    data[key] = id;\n    data[foreignKey] = fk;\n\n    try {\n      var item = await throughCollection.create(data);\n      response.body.done = true;\n      response.body.data = item;\n\n      await next();\n    } catch (err) {\n      if (err instanceof ValidationFail) {\n\n        response.body.errors = err.errors;\n        response.body.done = false;\n        await next();\n        return;\n      }\n\n      throw err;\n    }\n  }\n}\n\nexport function destroy({collection, foreignCollection, throughCollection, foreignKey, key}) {\n  return async function ({request, response, params}, next) {\n\n    var id = params.id;\n    var fk = params.fk;\n    response.body = response.body || {};\n\n    var joinList = await throughCollection.findAll({\n      where: {\n        [key]: id,\n        [foreignKey]: fk\n      }\n    });\n\n    if (joinList.length === 0) {\n      response.body.done = false;\n      response.body.errors = ['not_found'];\n      await next();\n      return;\n    }\n\n    var ids = joinList.map(function (item) {\n      return item.id;\n    });\n\n    var result = await throughCollection.destroy(ids);\n    response.body.done = result;\n\n    await next();\n  }\n\n}\n\n\n"]}