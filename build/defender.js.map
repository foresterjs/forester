{"version":3,"sources":["../lib/defender.js"],"names":[],"mappings":"AAAA;;;;;;AAEA,IAAM,UAAU,QAAQ,aAAR,CAAhB;;AAEA,IAAI,eAAe;AACjB,mBAAiB,QAAQ,yCAAR,CADA;AAEjB,OAAK,QAAQ,6BAAR,CAFY;AAGjB,WAAS,QAAQ,iCAAR,CAHQ;AAIjB,QAAM,QAAQ,6BAAR,CAJW;AAKjB,QAAM,QAAQ,6BAAR;AALW,CAAnB;;IAQM,Q;AAEJ,oBAAY,UAAZ,EAAwB;AAAA;;AAEtB,SAAK,UAAL,GAAkB,UAAlB;AACA,SAAK,KAAL,GAAa,KAAK,UAAL,CAAgB,MAAhB,CAAuB,QAAvB,IAAmC,EAAhD;AACA,SAAK,WAAL,GAAmB,EAAnB;;AAEA,SAAK,SAAL;AAED;;;;gCAEW;AAAA;;AACV,WAAK,KAAL,CAAW,OAAX,CAAmB,UAAC,IAAD,EAAU;;AAE3B,YAAI,WAAW,KAAK,QAAL,IAAiB,cAAhC;AACA,YAAI,SAAS,KAAK,MAAlB;AACA,YAAI,QAAQ,KAAK,KAAjB;;AAEA,YAAI,CAAC,MAAM,OAAN,CAAc,MAAd,CAAL,EAA4B,SAAS,CAAC,MAAD,CAAT;;AAE5B,eAAO,OAAP,CAAe,UAAC,MAAD,EAAY;AACzB,eAAK,MAAL,GAAc,MAAd;AACA,gBAAK,WAAL,CAAiB,QAAjB,IAA6B,MAAK,WAAL,CAAiB,QAAjB,KAA8B,EAA3D;AACA,gBAAK,WAAL,CAAiB,QAAjB,EAA2B,MAA3B,IAAqC,MAAK,WAAL,CAAiB,QAAjB,EAA2B,MAA3B,KAAsC,EAA3E;;AAEA,cAAI,CAAC,aAAa,cAAb,CAA4B,KAA5B,CAAL,EAAyC;AACvC,kBAAM,IAAI,KAAJ,CAAU,gBAAgB,KAAhB,GAAwB,2BAAlC,CAAN;AACD;;AAED,cAAI,aAAa,aAAa,KAAb,EAAoB,IAApB,EAA0B,MAAK,UAA/B,CAAjB;AACA,gBAAK,WAAL,CAAiB,QAAjB,EAA2B,MAA3B,EAAmC,IAAnC,CAAwC,UAAxC;AACD,SAXD;AAaD,OArBD;AAsBD;;;wBAEG,M,EAAmC;AAAA,UAA3B,QAA2B,yDAAhB,cAAgB;;;AAErC,UAAI,CAAC,KAAK,WAAL,CAAiB,QAAjB,CAAL,EAAiC;AAC/B,eAAO,QAAQ,CAAC,aAAa,IAAb,EAAD,CAAR,CAAP;AACD;;AAED,UAAI,WAAJ;;AAEA,UAAI,KAAK,WAAL,CAAiB,QAAjB,EAA2B,MAA3B,CAAJ,EAAwC;AACtC,sBAAc,KAAK,WAAL,CAAiB,QAAjB,EAA2B,MAA3B,CAAd;AACD,OAFD,MAEO;AACL,sBAAc,KAAK,WAAL,CAAiB,QAAjB,EAA2B,GAA3B,KAAmC,CAAC,aAAa,IAAb,EAAD,CAAjD;AACD;;AAED,aAAO,QAAQ,WAAR,CAAP;AAED;;;wCAE0B,I,EAAM,U,EAAY;AAC3C,mBAAa,IAAb,IAAqB,UAArB;AACD;;;;;;AAIH,OAAO,OAAP,GAAiB,QAAjB","file":"defender.js","sourcesContent":["'use strict';\n\nconst compose = require('koa-compose');\n\nvar checkMethods = {\n  isAuthenticated: require('./defender-middlewares/is-authenticated'),\n  isA: require('./defender-middlewares/is-a'),\n  isOwner: require('./defender-middlewares/is-owner'),\n  skip: require('./defender-middlewares/skip'),\n  halt: require('./defender-middlewares/halt')\n};\n\nclass Defender {\n\n  constructor(collection) {\n\n    this.collection = collection;\n    this.rules = this.collection.schema.defender || [];\n    this.middlewares = {};\n\n    this.initRules();\n\n  }\n\n  initRules() {\n    this.rules.forEach((rule) => {\n\n      var relation = rule.relation || \"__collection\";\n      var action = rule.action;\n      var check = rule.check;\n\n      if (!Array.isArray(action)) action = [action];\n\n      action.forEach((action) => {\n        rule.action = action;\n        this.middlewares[relation] = this.middlewares[relation] || {};\n        this.middlewares[relation][action] = this.middlewares[relation][action] || [];\n\n        if (!checkMethods.hasOwnProperty(check)) {\n          throw new Error(\"defender: '\" + check + \"' is a method non allowed\");\n        }\n\n        var middleware = checkMethods[check](rule, this.collection);\n        this.middlewares[relation][action].push(middleware);\n      });\n\n    });\n  }\n\n  acl(action, relation = \"__collection\") {\n\n    if (!this.middlewares[relation]) {\n      return compose([checkMethods.halt()]);\n    }\n\n    var middlewares;\n\n    if (this.middlewares[relation][action]) {\n      middlewares = this.middlewares[relation][action]\n    } else {\n      middlewares = this.middlewares[relation]['*'] || [checkMethods.halt()];\n    }\n\n    return compose(middlewares);\n\n  }\n\n  static registerCheckMethod(name, middleware) {\n    checkMethods[name] = middleware;\n  }\n\n}\n\nmodule.exports = Defender;\n"]}