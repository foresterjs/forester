{"version":3,"sources":["../lib/defender.js"],"names":[],"mappings":"AAAA,YAAY,CAAC;;;;;;AAEb,IAAM,OAAO,GAAG,OAAO,CAAC,aAAa,CAAC,CAAC;;AAEvC,IAAI,YAAY,GAAG;AACjB,iBAAe,EAAE,OAAO,CAAC,yCAAyC,CAAC;AACnE,KAAG,EAAE,OAAO,CAAC,6BAA6B,CAAC;AAC3C,SAAO,EAAE,OAAO,CAAC,iCAAiC,CAAC;AACnD,MAAI,EAAE,OAAO,CAAC,6BAA6B,CAAC;AAC5C,MAAI,EAAE,OAAO,CAAC,6BAA6B,CAAC;CAC7C,CAAC;;IAEI,QAAQ;AAEZ,WAFI,QAAQ,CAEA,UAAU,EAAE;0BAFpB,QAAQ;;AAIV,QAAI,CAAC,UAAU,GAAG,UAAU,CAAC;AAC7B,QAAI,CAAC,KAAK,GAAG,IAAI,CAAC,UAAU,CAAC,MAAM,CAAC,QAAQ,IAAI,EAAE,CAAC;AACnD,QAAI,CAAC,WAAW,GAAG,EAAE,CAAC;;AAEtB,QAAI,CAAC,SAAS,EAAE,CAAC;GAElB;;eAVG,QAAQ;;gCAYA;;;AACV,UAAI,CAAC,KAAK,CAAC,OAAO,CAAC,UAAC,IAAI,EAAK;;AAE3B,YAAI,QAAQ,GAAG,IAAI,CAAC,QAAQ,IAAI,cAAc,CAAC;AAC/C,YAAI,MAAM,GAAG,IAAI,CAAC,MAAM,CAAC;AACzB,YAAI,KAAK,GAAG,IAAI,CAAC,KAAK,CAAC;;AAEvB,YAAI,CAAC,KAAK,CAAC,OAAO,CAAC,MAAM,CAAC,EAAE,MAAM,GAAG,CAAC,MAAM,CAAC,CAAC;;AAE9C,cAAM,CAAC,OAAO,CAAC,UAAC,MAAM,EAAK;AACzB,cAAI,CAAC,MAAM,GAAG,MAAM,CAAC;AACrB,gBAAK,WAAW,CAAC,QAAQ,CAAC,GAAG,MAAK,WAAW,CAAC,QAAQ,CAAC,IAAI,EAAE,CAAC;AAC9D,gBAAK,WAAW,CAAC,QAAQ,CAAC,CAAC,MAAM,CAAC,GAAG,MAAK,WAAW,CAAC,QAAQ,CAAC,CAAC,MAAM,CAAC,IAAI,EAAE,CAAC;;AAE9E,cAAI,CAAC,YAAY,CAAC,cAAc,CAAC,KAAK,CAAC,EAAE;AACvC,kBAAM,IAAI,KAAK,CAAC,aAAa,GAAG,KAAK,GAAG,2BAA2B,CAAC,CAAC;WACtE;;AAED,cAAI,UAAU,GAAG,YAAY,CAAC,KAAK,CAAC,CAAC,IAAI,EAAE,MAAK,UAAU,CAAC,CAAC;AAC5D,gBAAK,WAAW,CAAC,QAAQ,CAAC,CAAC,MAAM,CAAC,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC;SACrD,CAAC,CAAC;OAEJ,CAAC,CAAC;KACJ;;;wBAEG,MAAM,EAA6B;UAA3B,QAAQ,yDAAG,cAAc;;AAEnC,UAAI,CAAC,IAAI,CAAC,WAAW,CAAC,QAAQ,CAAC,EAAE;AAC/B,eAAO,OAAO,CAAC,CAAC,YAAY,CAAC,IAAI,EAAE,CAAC,CAAC,CAAC;OACvC;;AAED,UAAI,WAAW,CAAC;;AAEhB,UAAI,IAAI,CAAC,WAAW,CAAC,QAAQ,CAAC,CAAC,MAAM,CAAC,EAAE;AACtC,mBAAW,GAAG,IAAI,CAAC,WAAW,CAAC,QAAQ,CAAC,CAAC,MAAM,CAAC,CAAA;OACjD,MAAM;AACL,mBAAW,GAAG,IAAI,CAAC,WAAW,CAAC,QAAQ,CAAC,CAAC,GAAG,CAAC,IAAI,CAAC,YAAY,CAAC,IAAI,EAAE,CAAC,CAAC;OACxE;;AAED,aAAO,OAAO,CAAC,WAAW,CAAC,CAAC;KAE7B;;;wCAE0B,IAAI,EAAE,UAAU,EAAE;AAC3C,kBAAY,CAAC,IAAI,CAAC,GAAG,UAAU,CAAC;KACjC;;;SAzDG,QAAQ;;;AA6Dd,MAAM,CAAC,OAAO,GAAG,QAAQ,CAAC","file":"defender.js","sourcesContent":["'use strict';\n\nconst compose = require('koa-compose');\n\nvar checkMethods = {\n  isAuthenticated: require('./defender-middlewares/is-authenticated'),\n  isA: require('./defender-middlewares/is-a'),\n  isOwner: require('./defender-middlewares/is-owner'),\n  skip: require('./defender-middlewares/skip'),\n  halt: require('./defender-middlewares/halt')\n};\n\nclass Defender {\n\n  constructor(collection) {\n\n    this.collection = collection;\n    this.rules = this.collection.schema.defender || [];\n    this.middlewares = {};\n\n    this.initRules();\n\n  }\n\n  initRules() {\n    this.rules.forEach((rule) => {\n\n      var relation = rule.relation || \"__collection\";\n      var action = rule.action;\n      var check = rule.check;\n\n      if (!Array.isArray(action)) action = [action];\n\n      action.forEach((action) => {\n        rule.action = action;\n        this.middlewares[relation] = this.middlewares[relation] || {};\n        this.middlewares[relation][action] = this.middlewares[relation][action] || [];\n\n        if (!checkMethods.hasOwnProperty(check)) {\n          throw new Error(\"defender: '\" + check + \"' is a method non allowed\");\n        }\n\n        var middleware = checkMethods[check](rule, this.collection);\n        this.middlewares[relation][action].push(middleware);\n      });\n\n    });\n  }\n\n  acl(action, relation = \"__collection\") {\n\n    if (!this.middlewares[relation]) {\n      return compose([checkMethods.halt()]);\n    }\n\n    var middlewares;\n\n    if (this.middlewares[relation][action]) {\n      middlewares = this.middlewares[relation][action]\n    } else {\n      middlewares = this.middlewares[relation]['*'] || [checkMethods.halt()];\n    }\n\n    return compose(middlewares);\n\n  }\n\n  static registerCheckMethod(name, middleware) {\n    checkMethods[name] = middleware;\n  }\n\n}\n\nmodule.exports = Defender;\n"]}